<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce Studio: Help Portal Creation Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chat-bubble, .canvas-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .layout-choice-button, .image-choice-button {
            border: 3px solid transparent;
            transition: border-color 0.2s ease-in-out;
        }
        .layout-choice-button:hover, .image-choice-button:hover {
            border-color: #93c5fd; /* Lighter blue for hover */
        }
        .selected-choice {
            border-color: #3b82f6 !important; /* Stronger blue for selection */
            box-shadow: 0 0 0 1px #3b82f6;
        }
        .preview-nav-tab {
            border-bottom: 3px solid transparent;
        }
        .preview-nav-tab.active {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- AI Assistant & Chat Panel -->
        <div class="w-2/5 bg-white p-6 shadow-lg flex flex-col">
            <div class="flex items-center mb-6">
                <img src="https://placehold.co/40x40/0070d2/ffffff?text=DRW" alt="Studio Logo" class="rounded-lg">
                <h1 class="text-2xl font-bold ml-3 text-gray-800">Salesforce Studio</h1>
            </div>
            
            <div class="flex-grow overflow-y-auto pr-2" id="chat-window">
                <div id="chat-container" class="space-y-4"></div>
            </div>
            
            <div class="mt-4 pt-4 border-t">
                <form id="chat-form" class="flex items-center space-x-2">
                    <input type="text" id="chat-input" placeholder="Click a suggestion to proceed..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" autocomplete="off" disabled>
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-300" disabled><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>

        <!-- Canvas/Preview Panel -->
        <div class="w-3/5 bg-gray-200 p-8 flex items-center justify-center">
            <div id="canvas" class="w-full h-full bg-white rounded-xl shadow-2xl overflow-hidden">
                <div id="canvas-content" class="h-full">
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <i class="fas fa-dog text-6xl text-gray-300 mb-4"></i>
                        <h2 class="text-3xl font-bold text-gray-700">Dog's Rule The World Portal</h2>
                        <p class="text-gray-500 mt-2">The AI-generated portal will appear here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let conversationState = 0;
    let userPages = [];
    let pageConfigs = {};
    let pageIndex = 0;
    const chatContainer = document.getElementById('chat-container');
    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const canvasContent = document.getElementById('canvas-content');

    const conversationFlow = [
        // 0: Initial Greeting
        {
            ai: () => aiSay("Hello Joe. I see you've started a new 'Help Portal' project for Dog's Rule The World. Let's start by choosing the pages for your portal.", [], [], true),
        },
        // 1: Page Selection
        {
            ai: () => {
                aiTyping();
                setTimeout(() => {
                    aiSayWithPageChoices("Here are some typical pages for a help portal. Please select all the pages you'd like to include.");
                }, 1500);
            },
        },
        // 2: Layout Selection for Home Page
        {
            ai: (selectedPages) => {
                userPages = selectedPages;
                pageIndex = 0; // Start with the first page (Home Page)
                aiTyping();
                setTimeout(() => {
                    const pageList = selectedPages.join(', ');
                    aiSay(`Great, we will create the following pages: ${pageList}. Let's start with the <strong>${userPages[pageIndex]}</strong>. Which layout do you prefer?`);
                    aiSayWithLayoutChoices();
                }, 1500);
            },
        },
        // 3: Ask to apply layout to all other pages
        {
            ai: (layoutChoice) => {
                aiTyping();
                setTimeout(() => {
                    aiSay(`Excellent choice. I'll use the '${layoutChoice}' layout for the Home Page. Would you like to apply this same layout to all the other pages you selected?`, [
                        { text: "Yes, apply to all.", nextState: 6, isPrimary: true },
                        { text: "No, let me configure them individually.", nextState: 4 }
                    ]);
                }, 1500);
            },
        },
        // 4: Configure next page
        {
            ai: () => {
                pageIndex++;
                if (pageIndex >= userPages.length) {
                    conversationState = 6;
                    conversationFlow[conversationState].ai();
                    return;
                }
                
                const currentPage = userPages[pageIndex];
                aiTyping();
                setTimeout(() => {
                    aiSay(`Okay, let's configure the <strong>${currentPage}</strong> page.`);
                    aiSayWithComponentRecommendations(currentPage);
                }, 1500);
            },
        },
        // 5: Image Source Selection
        {
            ai: () => {
                const currentPage = userPages[pageIndex];
                aiTyping();
                setTimeout(() => {
                    aiSayWithImageSourcePicklists(`Now, let's select the imagery for the <strong>${currentPage}</strong>. Use the picklists for a targeted search, or browse all sources.`);
                }, 1500);
            },
        },
        // 6: Data Connection Confirmation
        {
            ai: () => {
                aiTyping();
                setTimeout(() => {
                    aiSay(`Got it. All pages are configured. To populate the portal, I will connect to your Salesforce Unified Knowledge base for articles and Salesforce CMS for branding. Does that sound right?`, [
                        { text: "Correct. Proceed with those data sources.", nextState: 7, isPrimary: true }
                    ]);
                }, 1500);
            },
        },
        // 7: AI Generation
        {
            ai: () => {
                aiTyping();
                setTimeout(() => {
                    aiSay("Perfect. I'm scanning and indexing all published articles about veterinary care, grooming, and boarding from your Knowledge Base and pulling branding from CMS.");
                    setTimeout(() => {
                        renderPortalPreview();
                        aiSay("Done. I've generated the portal homepage with the selected layout, your branding, and categorized content.", [
                             { text: "Great. Now add the Agentforce Service Agent.", nextState: 8, isPrimary: true },
                             { text: "No, just add a 'Submit Ticket' button.", nextState: 9 }
                        ]);
                    }, 3000);
                }, 1000);
            },
        },
        // 8: Add Agentforce
        {
            ai: () => {
                aiTyping();
                setTimeout(() => {
                    aiSay("Excellent choice. I'll add the Agentforce Service Agent, which we'll call 'Doggy Chat', to the portal. I'm doing some work behind the scenes to pre-train it on your Knowledge Base and Service Catalog. I don't need anything else from you for this step.");
                     setTimeout(() => {
                        aiSay("The 'Doggy Chat' agent is now configured and added to the site. What's next?", [
                            { text: "Now add a 'Submit a Ticket' button as a fallback.", nextState: 9, isPrimary: true }
                        ]);
                    }, 3000);
                }, 1000);
            },
        },
        // 9: Add Fallback Button
        {
            ai: () => {
                aiTyping();
                setTimeout(() => {
                    aiSay("Good idea. I'll add a 'Submit a Ticket' button to the header and at the bottom of every article page. I'll also generate a standard form for it.");
                    setTimeout(() => {
                        addTicketButtonToPreview();
                        aiSay("The button and form have been added. How should I configure the form's submission logic?", [
                            { text: "On submit, create a Case in Service Cloud.", nextState: 10 }
                        ]);
                    }, 2000);
                }, 1000);
            },
        },
        // 10: Workflow Integration & Final Preview
        {
            ai: () => {
                aiTyping();
                setTimeout(() => {
                    aiSay("Excellent. I'll set the rule: On submit, create a new Case in Salesforce Service Cloud and assign it to the 'Tier 1 Support' queue.");
                    renderLeadWorkflow();
                    setTimeout(() => {
                        aiSay("The workflow is configured. The portal is complete. Here is the final interactive preview. Please click through the pages and test the chatbot to ensure everything is correct.", [
                            { text: "Publish Site", nextState: 11, isPrimary: true, isFinal: true },
                            { text: "Download Code", nextState: 14 },
                            { text: "Do Both", nextState: 15 }
                        ]);
                        renderFullPortalPreview(userPages);
                    }, 2500);
                }, 1000);
            },
        },
        // 11: Publish
        {
            ai: () => {
                aiTyping();
                setTimeout(() => {
                    renderFinalScreen();
                    aiSay("Success! The Dog's Rule The World Help Portal is now live and available to your customers.");
                    chatInput.disabled = true;
                    chatInput.placeholder = "Conversation ended.";
                }, 1500);
            },
        },
        // 12: Image Suggestion
        {
            ai: (source) => {
                aiTyping();
                setTimeout(() => {
                    aiSayWithImages(`Searching for images in <em>${source}</em>... Here are a few options for the <strong>${userPages[pageIndex]}</strong> page.`, [
                        { src: `https://placehold.co/150x100/1e40af/ffffff?text=${userPages[pageIndex].replace(' ','+')}+V1`, alt: 'Image 1' },
                        { src: `https://placehold.co/150x100/059669/ffffff?text=${userPages[pageIndex].replace(' ','+')}+V2`, alt: 'Image 2' },
                        { src: `https://placehold.co/150x100/be123c/ffffff?text=${userPages[pageIndex].replace(' ','+')}+V3`, alt: 'Image 3' }
                    ]);
                }, 2000);
            },
        },
        // 13: Alternate Component Suggestions
        {
            ai: () => {
                const currentPage = userPages[pageIndex];
                aiTyping();
                setTimeout(() => {
                    aiSayWithAlternateComponentChoices(currentPage);
                }, 1500);
            },
        },
        // 14: Download Only (NEW)
        {
            ai: () => {
                aiTyping();
                setTimeout(() => {
                    aiSay("No problem. Preparing the code package for download...", [
                        { text: "Thanks! Now publish the site.", nextState: 11, isPrimary: true, isFinal: true }
                    ]);
                }, 1000);
            },
        },
        // 15: Do Both (NEW)
        {
            ai: () => {
                aiTyping();
                setTimeout(() => {
                    aiSay("You got it. Preparing the code package for download and publishing the site now.");
                    setTimeout(() => {
                        conversationState = 11;
                        conversationFlow[conversationState].ai();
                    }, 1500);
                }, 1000);
            },
        }
    ];

    function aiSay(text, buttons = [], suggestions = [], isFirst = false) {
        const messageWrapper = createMessageElement(text, buttons, suggestions);
        chatContainer.appendChild(messageWrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        if (isFirst) {
            conversationState = 1;
            conversationFlow[conversationState].ai();
        }
    }

    function aiSayWithPageChoices(text) {
        let pagesHtml = '<div id="page-selection-form" class="mt-2 space-y-2">';
        const pages = ['Home Page', 'Knowledge Base', 'Our Services', 'Book an Appointment', 'Contact Us'];
        pagesHtml += pages.map(page => `
            <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" value="${page}" checked>
                <span class="ml-3 text-sm">${page}</span>
            </label>
        `).join('');
        pagesHtml += `<button id="confirm-pages-btn" class="mt-3 text-sm px-4 py-2 rounded-full transition duration-200 bg-blue-600 text-white hover:bg-blue-700">Confirm Pages</button></div>`;
        
        const messageWrapper = createMessageElement(text, [], [], pagesHtml);
        chatContainer.appendChild(messageWrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        document.getElementById('confirm-pages-btn').addEventListener('click', (e) => {
            const selectedPages = [];
            document.querySelectorAll('#page-selection-form input:checked').forEach(input => {
                selectedPages.push(input.value);
            });
            if (selectedPages.length > 0) {
                selectedPages.forEach(p => pageConfigs[p] = { componentSet: 'original' });
                e.target.disabled = true;
                userSay(`I've selected the following pages: ${selectedPages.join(', ')}`);
                conversationState = 2;
                conversationFlow[conversationState].ai(selectedPages);
            } else {
                alert("Please select at least one page.");
            }
        });
    }
    
    function aiSayWithLayoutChoices() {
        let layoutsHtml = '<div class="mt-2 grid grid-cols-3 gap-2">';
        const layoutStyles = [
            { name: 'Classic', img: 'https://placehold.co/150x100/e0e7ff/4338ca?text=Classic' },
            { name: 'Modern', img: 'https://placehold.co/150x100/d1fae5/047857?text=Modern' },
            { name: 'Compact', img: 'https://placehold.co/150x100/f3f4f6/4b5563?text=Compact' }
        ];
        layoutsHtml += layoutStyles.map(layout => `
            <button class="layout-choice-button rounded-lg overflow-hidden focus:outline-none text-center" data-value="${layout.name}" data-next-state="3">
                <img src="${layout.img}" alt="${layout.name} layout style" class="w-full h-auto object-cover bg-white pointer-events-none">
                <span class="text-xs font-semibold p-1 block bg-gray-100 pointer-events-none">${layout.name}</span>
            </button>
        `).join('');
        layoutsHtml += '</div>';
        
        const messageWrapper = createMessageElement("Here are a few layout options for the Home Page.", [], [], layoutsHtml);
        chatContainer.appendChild(messageWrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function aiSayWithComponentRecommendations(pageName) {
        let components = [];
        let previewHtml = '';

        switch(pageName) {
            case 'Knowledge Base':
                components = ['A **Search Bar** component for easy lookups.', 'A **Category Filter** component to narrow results by topic (Health, Training).', 'An **Article List** component to display results.'];
                previewHtml = `<div class="p-4 border rounded-lg bg-white"><h3 class="font-bold mb-2">${pageName}</h3><div class="space-y-2"><div class="w-full h-6 bg-gray-200 rounded"></div><div class="w-full h-10 bg-gray-300 rounded"></div><div class="w-full h-10 bg-gray-300 rounded"></div></div></div>`;
                break;
            case 'Our Services':
                components = ['A **Service Catalog** component to display options like Grooming, Boarding, and Vet Care.', 'A **Promotional Banners** component for special offers (e.g., "Puppy\'s First Grooming").'];
                 previewHtml = `<div class="p-4 border rounded-lg bg-white"><h3 class="font-bold mb-2">${pageName}</h3><div class="flex space-x-2"><div class="w-1/2 h-20 bg-blue-200 rounded flex items-center justify-center text-xs text-blue-800 font-bold">Grooming</div><div class="w-1/2 h-20 bg-green-200 rounded flex items-center justify-center text-xs text-green-800 font-bold">Boarding</div></div></div>`;
                break;
            case 'Book an Appointment':
                components = ['An interactive **Appointment Calendar** component.', 'A **Staff Selector** component to choose a specific vet or groomer.', 'A **Location & Hours** component.'];
                previewHtml = `<div class="p-4 border rounded-lg bg-white"><h3 class="font-bold mb-2">${pageName}</h3><div class="flex space-x-2"><div class="w-2/3 h-24 bg-red-200 rounded flex items-center justify-center text-xs text-red-800 font-bold">Calendar</div><div class="w-1/3 h-24 bg-yellow-200 rounded flex items-center justify-center text-xs text-yellow-800 font-bold">Hours</div></div></div>`;
                break;
            case 'Contact Us':
                components = ['A **Contact Form** component for inquiries.', 'An **Interactive Map** component showing your location.', 'An **Address & Hours** component.'];
                 previewHtml = `<div class="p-4 border rounded-lg bg-white"><h3 class="font-bold mb-2">${pageName}</h3><div class="flex space-x-2"><div class="w-1/2 h-24 bg-purple-200 rounded flex items-center justify-center text-xs text-purple-800 font-bold">Form</div><div class="w-1/2 h-24 bg-indigo-200 rounded flex items-center justify-center text-xs text-indigo-800 font-bold">Map</div></div></div>`;
                break;
            default:
                components = ['A **Standard Content Block** for custom text and images.'];
                previewHtml = `<div class="p-4 border rounded-lg bg-white"><h3 class="font-bold mb-2">${pageName}</h3><div class="w-full h-20 bg-gray-300 rounded"></div></div>`;
        }
        
        const componentList = components.map(c => `<li>• ${c}</li>`).join('');
        const text = `For the <strong>${pageName}</strong> page, I recommend the following components:<ul>${componentList}</ul>`;

        const messageWrapper = createMessageElement(text, [
            { text: "Looks good, use these.", nextState: 5, isPrimary: true, componentSet: 'original' },
            { text: "Suggest other components.", nextState: 13 }
        ], [], previewHtml);
        chatContainer.appendChild(messageWrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function aiSayWithAlternateComponentChoices(pageName) {
        let components = [];
        let previewHtml = '';

        switch(pageName) {
            case 'Knowledge Base':
                components = ['A **Featured Articles** component to highlight popular topics.', 'A **Topic Cloud** component for visual navigation.', 'A **Recent Activity Feed** to show new articles.'];
                previewHtml = `<div class="p-4 border rounded-lg bg-white"><h3 class="font-bold mb-2">${pageName} (Alt)</h3><div class="flex space-x-2"><div class="w-1/2 h-20 bg-yellow-200 rounded flex items-center justify-center text-xs text-yellow-800 font-bold">Featured</div><div class="w-1/2 h-20 bg-pink-200 rounded flex items-center justify-center text-xs text-pink-800 font-bold">Topics</div></div></div>`;
                break;
            case 'Our Services':
                components = ['A **Pricing Table** component to clearly show costs.', 'A **Customer Testimonials** component for social proof.', 'A **Service Comparison Chart** to help customers choose.'];
                 previewHtml = `<div class="p-4 border rounded-lg bg-white"><h3 class="font-bold mb-2">${pageName} (Alt)</h3><div class="w-full h-24 bg-teal-200 rounded flex items-center justify-center text-xs text-teal-800 font-bold">Pricing Table</div></div>`;
                break;
            case 'Book an Appointment':
                components = ['A **Service Duration** component to show appointment lengths.', 'A **Pre-appointment Checklist** for pet parents.', '**Vet & Groomer Profiles** to introduce your staff.'];
                previewHtml = `<div class="p-4 border rounded-lg bg-white"><h3 class="font-bold mb-2">${pageName} (Alt)</h3><div class="space-y-2"><div class="w-full h-10 bg-cyan-200 rounded flex items-center justify-center text-xs text-cyan-800 font-bold">Checklist</div><div class="w-full h-10 bg-sky-200 rounded flex items-center justify-center text-xs text-sky-800 font-bold">Vet Profiles</div></div></div>`;
                break;
            case 'Contact Us':
                components = ['An **FAQ** component for common questions.', 'A **Business Hours** component.', '**Social Media Links** to connect with your community.'];
                 previewHtml = `<div class="p-4 border rounded-lg bg-white"><h3 class="font-bold mb-2">${pageName} (Alt)</h3><div class="w-full h-24 bg-orange-200 rounded flex items-center justify-center text-xs text-orange-800 font-bold">FAQ</div></div>`;
                break;
            default:
                components = ['An **Image Gallery** component.', 'A **Video Embed** component.'];
                previewHtml = `<div class="p-4 border rounded-lg bg-white"><h3 class="font-bold mb-2">${pageName} (Alt)</h3><div class="w-full h-20 bg-gray-300 rounded"></div></div>`;
        }
        
        const componentList = components.map(c => `<li>• ${c}</li>`).join('');
        const text = `No problem. Here are some alternative components for the <strong>${pageName}</strong> page:<ul>${componentList}</ul>`;

        const messageWrapper = createMessageElement(text, [
            { text: "Great, I'll use these.", nextState: 5, isPrimary: true, componentSet: 'alternate' },
            { text: "Go back to original.", nextState: 4, componentSet: 'original' }
        ], [], previewHtml);
        chatContainer.appendChild(messageWrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    function aiSayWithImages(text, images = []) {
        let imagesHtml = '<div class="mt-2 grid grid-cols-3 gap-2">';
        images.forEach(img => {
            imagesHtml += `
                <button class="image-choice-button rounded-lg overflow-hidden focus:outline-none" data-value="${img.src}" data-next-state="4">
                    <img src="${img.src}" alt="${img.alt}" class="w-full h-auto object-cover pointer-events-none">
                </button>
            `;
        });
        imagesHtml += '</div>';
        
        const messageWrapper = createMessageElement(text, [], [], imagesHtml);
        chatContainer.appendChild(messageWrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function aiSayWithImageSourcePicklists(text) {
        let picklistHtml = `<div id="image-source-form" class="mt-2 space-y-3">`;
        const externalSources = ['Bynder', 'Adobe', 'Jasper', 'Typeface', 'Cloudinary'];
        const cmsWorkspaces = ['Marketing Workspace', 'Legal Workspace', 'All Company Workspace', 'Commerce Workspace'];

        picklistHtml += `
            <div>
                <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="checkbox" id="ext-source-toggle" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="ml-3 text-sm font-semibold">External Content Sources</span>
                </label>
                <div id="ext-source-options" class="hidden pl-8 pt-2 space-y-1">
                    ${externalSources.map(s => `<label class="flex items-center text-sm"><input type="checkbox" class="h-4 w-4" value="${s}"> <span class="ml-2">${s}</span></label>`).join('')}
                </div>
            </div>
            <div>
                <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="checkbox" id="cms-source-toggle" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="ml-3 text-sm font-semibold">CMS Workspaces</span>
                </label>
                <div id="cms-source-options" class="hidden pl-8 pt-2 space-y-1">
                     ${cmsWorkspaces.map(w => `<label class="flex items-center text-sm"><input type="checkbox" class="h-4 w-4" value="${w}"> <span class="ml-2">${w}</span></label>`).join('')}
                </div>
            </div>
             <button id="browse-all-btn" class="action-button text-sm w-full p-2 rounded-full transition duration-200 bg-gray-200 text-gray-800 hover:bg-gray-300" data-next-state="12" data-value="all sources">Browse all sources</button>
             <button id="find-images-btn" class="mt-3 text-sm px-4 py-2 rounded-full transition duration-200 bg-blue-600 text-white hover:bg-blue-700">Find Images</button>
        `;
        picklistHtml += `</div>`;

        const messageWrapper = createMessageElement(text, [], [], picklistHtml);
        chatContainer.appendChild(messageWrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        const form = messageWrapper.querySelector('#image-source-form');
        form.querySelector('#ext-source-toggle').addEventListener('change', (e) => {
            form.querySelector('#ext-source-options').classList.toggle('hidden', !e.target.checked);
        });
        form.querySelector('#cms-source-toggle').addEventListener('change', (e) => {
            form.querySelector('#cms-source-options').classList.toggle('hidden', !e.target.checked);
        });
        form.querySelector('#find-images-btn').addEventListener('click', (e) => {
            const selectedSources = [];
            form.querySelectorAll('input:checked').forEach(input => {
                if(input.value && input.value !== 'on') selectedSources.push(input.value);
            });
             if (selectedSources.length > 0) {
                e.target.disabled = true;
                userSay(`Searching for images in: ${selectedSources.join(', ')}`);
                conversationState = 12;
                conversationFlow[conversationState].ai(selectedSources.join(', '));
            } else {
                alert("Please select at least one source, or choose 'Browse all sources'.");
            }
        });
         form.querySelector('#browse-all-btn').addEventListener('click', handleActionButtonClick);
    }

    function createMessageElement(text, buttons, suggestions, customHtml = '') {
        let buttonsHtml = '';
        if (buttons.length > 0) {
            buttonsHtml += '<div class="mt-2 flex items-center space-x-2">';
            buttons.forEach(btn => {
                const primaryClass = btn.isPrimary ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800';
                const finalClass = btn.isFinal ? 'bg-green-600 hover:bg-green-700 text-white' : 'hover:bg-gray-300';
                const componentData = btn.componentSet ? `data-component-set="${btn.componentSet}"` : '';
                buttonsHtml += `<button data-next-state="${btn.nextState}" ${componentData} class="action-button text-sm px-3 py-1 rounded-full transition duration-200 ${primaryClass} ${finalClass}">${btn.text}</button>`;
            });
            buttonsHtml += '</div>';
        }
        
        const messageWrapper = document.createElement('div');
        messageWrapper.innerHTML = `<div class="chat-bubble flex"><div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3"><i class="fas fa-robot text-white"></i></div><div class="bg-white p-3 rounded-lg border border-gray-200 max-w-md"><p class="text-sm text-gray-800">${text}</p>${customHtml}${buttonsHtml}</div></div>`;
        const messageElement = messageWrapper.firstElementChild;

        messageElement.querySelectorAll('.action-button, .layout-choice-button, .image-choice-button').forEach(button => {
            button.addEventListener('click', handleActionButtonClick);
        });
        
        return messageElement;
    }

    function aiTyping() {
        const typingIndicator = `<div id="typing-indicator" class="chat-bubble flex"><div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3"><i class="fas fa-robot text-white"></i></div><div class="bg-white p-3 rounded-lg border border-gray-200"><i class="fas fa-spinner fa-pulse text-gray-500"></i></div></div>`;
        chatContainer.innerHTML += typingIndicator;
        chatWindow.scrollTop = chatWindow.scrollHeight;
        setTimeout(() => {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }, 5000); // Failsafe removal
    }

    function userSay(text) {
        const messageHtml = `<div class="chat-bubble flex justify-end"><div class="bg-blue-600 text-white p-3 rounded-lg max-w-md"><p class="text-sm">${text}</p></div><div class="flex-shrink-0 w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center ml-3"><span class="font-bold text-white">J</span></div></div>`;
        chatContainer.innerHTML += messageHtml;
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function handleActionButtonClick(e) {
        const button = e.target.closest('.action-button, .layout-choice-button, .image-choice-button');
        if (!button) return;

        const componentSet = button.dataset.componentSet;
        if (componentSet) {
            const currentPage = userPages[pageIndex];
            pageConfigs[currentPage].componentSet = componentSet;
        }

        if (button.classList.contains('layout-choice-button') || button.classList.contains('image-choice-button')) {
            const choiceGroup = button.parentElement.querySelectorAll('.layout-choice-button, .image-choice-button');
            choiceGroup.forEach(btn => {
                btn.classList.remove('selected-choice');
                btn.disabled = true;
            });
            button.classList.add('selected-choice');
        } else {
            const parentContainer = button.closest('.mt-2, #image-source-form');
            if (parentContainer) {
                parentContainer.querySelectorAll('button').forEach(b => b.disabled = true);
            }
        }

        const nextState = parseInt(button.dataset.nextState);
        const userChoiceText = button.dataset.value || button.textContent;
        
        setTimeout(() => {
            if (button.classList.contains('layout-choice-button')) {
                 userSay(`I'll use the ${userChoiceText} layout.`);
            } else if (button.classList.contains('image-choice-button')) {
                userSay("I'll use this image.");
            } else {
                userSay(userChoiceText);
            }
            
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) typingIndicator.remove();

            conversationState = nextState;
            if (conversationFlow[conversationState]) {
                conversationFlow[conversationState].ai(userChoiceText);
            } else {
                console.error("Invalid next state:", nextState);
            }
        }, 400);
    }

    function renderPortalPreview() {
        canvasContent.innerHTML = `
        <div class="canvas-content h-full flex flex-col bg-gray-50">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center flex-shrink-0 border-b">
                <div class="flex items-center"><img src="https://placehold.co/32x32/0070d2/ffffff?text=DRW" class="rounded-lg mr-2"><span class="font-bold">Dog's Rule The World</span></div>
                <nav class="text-sm font-semibold space-x-4">
                    <a href="#" class="text-blue-600">Home</a>
                    <a href="#" class="text-gray-600 hover:text-blue-600">Services</a>
                    <a href="#" class="text-gray-600 hover:text-blue-600">Appointments</a>
                </nav>
            </header>
            <main class="flex-grow p-6 overflow-y-auto">
                <div class="text-center py-10 bg-white rounded-lg shadow-sm" style="background-image: url('https://placehold.co/1200x300/e0f2fe/0c4a6e?text=Happy+Pups!'); background-size: cover; background-position: center;">
                    <h1 class="text-3xl font-bold text-gray-800">How can we help your furry friend?</h1>
                    <input type="search" placeholder="Search for grooming, boarding, vet info..." class="mt-4 w-full max-w-lg p-3 border rounded-full">
                </div>
                <div class="mt-8 grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="font-bold">Veterinary Care</h3><p class="text-sm text-gray-500">Check-ups, vaccines, and more.</p></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="font-bold">Boarding & Lodging</h3><p class="text-sm text-gray-500">A safe and fun home away from home.</p></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="font-bold">Grooming Services</h3><p class="text-sm text-gray-500">Keep your pup looking their best.</p></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="font-bold">Nutrition Guides</h3><p class="text-sm text-gray-500">Healthy eating for a happy dog.</p></div>
                </div>
            </main>
        </div>`;
    }

    function renderFullPortalPreview(pages) {
        let tabsHtml = pages.map((page, index) => 
            `<button class="preview-nav-tab px-4 py-2 text-sm font-semibold text-gray-600 ${index === 0 ? 'active' : ''}" data-page="${page}">${page.replace(' Page', '')}</button>`
        ).join('');

        canvasContent.innerHTML = `
        <div class="canvas-content h-full flex flex-col bg-gray-200 relative">
            <header class="bg-white p-4 flex justify-between items-center flex-shrink-0 border-b z-10">
                <div class="flex items-center"><img src="https://placehold.co/32x32/0070d2/ffffff?text=DRW" class="rounded-lg mr-2"><span class="font-bold">Dog's Rule The World</span></div>
            </header>
            <div class="bg-white border-b shadow-sm z-10">
                <nav class="flex justify-center -mb-px">
                    ${tabsHtml}
                </nav>
            </div>
            <main id="preview-main-content" class="flex-grow p-6 overflow-y-auto bg-gray-50">
                <!-- Content will be swapped here -->
            </main>
            
            <!-- Chatbot Elements -->
            <div id="doggy-chat-bubble" class="fixed bottom-6 right-24 cursor-pointer z-20 w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center shadow-xl hover:scale-110 transition-transform">
                <i class="fas fa-paw fa-2x text-white"></i>
            </div>
            <div id="doggy-chat-modal" class="modal fixed inset-0 z-30 flex items-end justify-end p-6 bg-black bg-opacity-50 opacity-0 pointer-events-none">
                <div class="modal-content bg-white w-full max-w-md rounded-xl shadow-2xl transform translate-y-8">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="text-lg font-bold flex items-center"><i class="fas fa-paw mr-2 text-blue-600"></i>Doggy Chat</h3>
                        <button id="close-doggy-chat-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    </div>
                    <div id="doggy-chat-window" class="p-4 h-80 overflow-y-auto">
                        <div class="flex mb-4"><div class="bg-gray-200 p-3 rounded-lg max-w-xs"><p>Woof! I'm the Doggy Chat assistant. How can I help you today?</p></div></div>
                    </div>
                    <div class="p-4 border-t">
                        <form id="doggy-chat-form" class="flex items-center space-x-2">
                            <input type="text" id="doggy-chat-input" placeholder="Ask a question..." class="w-full p-2 border border-gray-300 rounded-lg">
                            <button type="submit" class="bg-blue-600 text-white p-2 rounded-lg"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </div>`;
        
        const mainContent = document.getElementById('preview-main-content');
        
        const renderPageContent = (pageName) => {
            const config = pageConfigs[pageName] || { componentSet: 'original' }; // Fallback to original
            switch(pageName) {
                case 'Home Page':
                    mainContent.innerHTML = `<div class="text-center py-10 bg-white rounded-lg shadow-sm" style="background-image: url('https://placehold.co/1200x300/e0f2fe/0c4a6e?text=Happy+Pups!'); background-size: cover; background-position: center;"><h1 class="text-3xl font-bold text-gray-800">How can we help your furry friend?</h1><input type="search" placeholder="Search for grooming, boarding, vet info..." class="mt-4 w-full max-w-lg p-3 border rounded-full"></div><div class="mt-8 grid grid-cols-2 gap-4"><div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="font-bold">Veterinary Care</h3><p class="text-sm text-gray-500">Check-ups, vaccines, and more.</p></div><div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="font-bold">Boarding & Lodging</h3><p class="text-sm text-gray-500">A safe and fun home away from home.</p></div></div>`;
                    break;
                case 'Knowledge Base':
                    if (config.componentSet === 'alternate') {
                         mainContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">Knowledge Base</h2><div class="bg-white p-6 rounded-lg shadow-sm"><div class="grid grid-cols-2 gap-4"><div class="p-4 bg-yellow-100 rounded-lg text-center"><h3 class="font-bold text-yellow-800">Featured: Puppy Training</h3><p class="text-sm">Top tips for your new family member.</p></div><div class="p-4 bg-pink-100 rounded-lg text-center"><h3 class="font-bold text-pink-800">Topic Cloud</h3><p class="text-sm">Health, Nutrition, Behavior...</p></div></div></div>`;
                    } else {
                        mainContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">Knowledge Base</h2><div class="bg-white p-6 rounded-lg shadow-sm"><input type="search" placeholder="Search articles..." class="w-full p-2 border rounded-md mb-4"><div class="grid grid-cols-3 gap-4 text-center"><div class="p-4 bg-gray-100 rounded-lg"><i class="fas fa-heartbeat mb-2 text-red-500"></i><p class="text-sm font-semibold">Health & Wellness</p></div><div class="p-4 bg-gray-100 rounded-lg"><i class="fas fa-bone mb-2 text-yellow-500"></i><p class="text-sm font-semibold">Training Tips</p></div><div class="p-4 bg-gray-100 rounded-lg"><i class="fas fa-utensils mb-2 text-green-500"></i><p class="text-sm font-semibold">Nutrition</p></div></div></div>`;
                    }
                    break;
                case 'Our Services':
                     if (config.componentSet === 'alternate') {
                        mainContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">Our Services</h2><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="font-bold text-lg text-center mb-2">Service Pricing</h3><p class="text-sm text-center text-gray-600">A full pricing table would be displayed here.</p></div>`;
                    } else {
                        mainContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">Our Services</h2><div class="grid grid-cols-2 gap-4"><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="font-bold text-lg">Veterinary Care</h3><p class="text-sm text-gray-600 mt-1">Full-service vet clinic for all your dog's health needs.</p></div><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="font-bold text-lg">Grooming</h3><p class="text-sm text-gray-600 mt-1">Professional grooming to keep your pup looking sharp.</p></div><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="font-bold text-lg">Boarding</h3><p class="text-sm text-gray-600 mt-1">Safe and comfortable lodging while you're away.</p></div><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="font-bold text-lg">Day Care</h3><p class="text-sm text-gray-600 mt-1">Fun and supervised play for your energetic dog.</p></div></div>`;
                    }
                    break;
                case 'Book an Appointment':
                     mainContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">Book an Appointment</h2><div class="bg-white p-6 rounded-lg shadow-sm"><p class="text-center">A fully interactive calendar and booking form would be displayed here, allowing customers to select a service, a professional, and a time slot.</p><img src="https://placehold.co/600x300/f3f4f6/4b5563?text=Interactive+Calendar+Mockup" class="w-full rounded-lg mt-4"/></div>`;
                    break;
                 case 'Contact Us':
                    mainContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">Contact Us</h2><div class="grid grid-cols-2 gap-6"><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="font-bold mb-2">Send us a Message</h3><form class="space-y-2"><input type="text" placeholder="Your Name" class="w-full p-2 border rounded"><input type="email" placeholder="Your Email" class="w-full p-2 border rounded"><textarea placeholder="Your Message" class="w-full p-2 border rounded"></textarea><button type="button" class="bg-blue-600 text-white px-4 py-2 rounded">Send</button></form></div><div class="bg-white rounded-lg shadow-sm"><img src="https://placehold.co/600x400/e0e7ff/4338ca?text=Location+Map" class="w-full h-full object-cover rounded-lg"/></div></div>`;
                    break;
            }
        };

        document.querySelectorAll('.preview-nav-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                document.querySelectorAll('.preview-nav-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                renderPageContent(e.target.dataset.page);
            });
        });
        
        // Chatbot logic
        const chatBubble = document.getElementById('doggy-chat-bubble');
        const chatModal = document.getElementById('doggy-chat-modal');
        const closeModalBtn = document.getElementById('close-doggy-chat-modal');
        const chatWindow = document.getElementById('doggy-chat-window');
        const chatForm = document.getElementById('doggy-chat-form');
        const chatInput = document.getElementById('doggy-chat-input');

        chatBubble.addEventListener('click', () => {
            chatModal.classList.remove('opacity-0', 'pointer-events-none');
            chatModal.querySelector('.modal-content').classList.remove('translate-y-8');
        });
        closeModalBtn.addEventListener('click', () => {
            chatModal.querySelector('.modal-content').classList.add('translate-y-8');
            chatModal.classList.add('opacity-0');
            setTimeout(() => chatModal.classList.add('pointer-events-none'), 300);
        });
        
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userInput = chatInput.value.trim().toLowerCase();
            if (!userInput) return;

            chatWindow.innerHTML += `<div class="flex justify-end mb-4"><div class="bg-blue-600 text-white p-3 rounded-lg max-w-xs"><p>${chatInput.value}</p></div></div>`;
            chatInput.value = '';
            chatWindow.scrollTop = chatWindow.scrollHeight;

            setTimeout(() => {
                let aiResponse = "I'm sorry, I can only answer a few questions for this demo. Try asking about services, your order, or when to take your pet to the doctor.";
                if (userInput.includes('doctor') || userInput.includes('eating') || userInput.includes('sleeping')) {
                    aiResponse = "Changes in eating or sleeping can be a sign of illness. It's always best to consult a vet. Would you like to book an appointment? (Source: Knowledge Base)";
                } else if (userInput.includes('order')) {
                    aiResponse = "Looking up your recent orders... It looks like your order #DRW12345 of premium dog food is scheduled for delivery tomorrow! (Source: Order System)";
                } else if (userInput.includes('services')) {
                    aiResponse = "We offer Veterinary Care, Grooming, Boarding, and Day Care services. You can learn more on our 'Our Services' page. (Source: CMS)";
                }
                chatWindow.innerHTML += `<div class="flex mb-4"><div class="bg-gray-200 p-3 rounded-lg max-w-xs"><p>${aiResponse}</p></div></div>`;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }, 1000);
        });

        // Render initial page
        renderPageContent(pages[0]);
    }

    function addTicketButtonToPreview() {
        const header = canvasContent.querySelector('header');
        if(header) {
            const nav = header.querySelector('nav');
            const button = document.createElement('button');
            button.className = "ml-4 bg-blue-600 text-white font-semibold px-3 py-1 rounded-lg text-sm";
            button.textContent = "Submit a Ticket";
            nav.parentNode.insertBefore(button, nav.nextSibling);
        }
    }

    function renderLeadWorkflow() {
        canvasContent.innerHTML = `<div class="canvas-content h-full flex flex-col items-center justify-center bg-gray-50 p-8"><h2 class="text-2xl font-bold text-gray-800 mb-6">Workflow: On Ticket Submit</h2><div class="space-y-4 w-full max-w-md"><div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-yellow-500"><h3 class="font-bold flex items-center"><i class="fas fa-mouse-pointer-alt mr-2 text-yellow-500"></i>Trigger</h3><p class="text-gray-600 ml-6">User clicks 'Submit' on the Ticket Form.</p></div><div class="flex justify-center"><i class="fas fa-arrow-down text-gray-400"></i></div><div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-green-500"><h3 class="font-bold flex items-center"><i class="fas fa-plus-circle mr-2 text-green-500"></i>Action</h3><p class="text-gray-600 ml-6">Create a new <strong>Case</strong> in <strong>Service Cloud</strong>.</p></div><div class="flex justify-center"><i class="fas fa-arrow-down text-gray-400"></i></div><div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-purple-500"><h3 class="font-bold flex items-center"><i class="fas fa-users mr-2 text-purple-500"></i>Assignment</h3><p class="text-gray-600 ml-6">Assign Case to the '<strong>Tier 1 Support</strong>' queue.</p></div></div></div>`;
    }

    function renderFinalScreen() {
        canvasContent.innerHTML = `<div class="h-full flex flex-col items-center justify-center bg-green-50 p-8 text-center"><i class="fas fa-check-circle text-8xl text-green-500 mb-6"></i><h2 class="text-4xl font-extrabold text-green-800">Help Portal Published!</h2><p class="text-gray-600 mt-2 max-w-md">The self-service portal for Dog's Rule The World is now live!</p></div>`;
    }

    // Initialize
    conversationFlow[0].ai();
});
</script>
</body>
</html>
